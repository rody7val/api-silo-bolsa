var sensorLib = require('node-dht-sensor');
var config = require('../config');
var App = require('../app');
var ip = require('ip');

// socket
App.io.on('connection', function (socket) {
	var timeOut;
	var sensorObj = {
		sensor: {
			name: "Exterior",
			type: 22,
			pin: 4
		},
		read: function() {
			var data = sensorLib.read(this.sensor.type, this.sensor.pin);
			console.log(`${this.sensor.name}: ${data.temperature.toFixed(1)}Â°C, ${data.humidity.toFixed(1)}%`);
			// enviar temperatura y humedad exterior
			this.sensor.data = data;
			socket.emit('dht22', this.sensor);

			timeOut = setTimeout(function() {
				sensorObj.read();
			}, 2000);
		}
	};

	socket.on('stop-dht22', function() { clearTimeout(timeOut) });

});

// server
App.server.listen(config.port, function (err) {
    if (err) return console.log(err);
	var protocol = 'http://';
	console.log('####');
	console.log(`Servidor local: ${protocol}localhost:${config.port}`);
	console.log(`Servidor en tu red: ${protocol}${ip.address()}:${config.port}`);
	console.log('####');
});